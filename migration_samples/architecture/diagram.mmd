%% Mermaid architecture diagram for Stellara microservices
flowchart LR
  subgraph Gateway
    Envoy[Envoy API Gateway]
  end

  subgraph Services
    Identity[Identity Service]
    Marketplace[Marketplace Service]
    Payments[Payments Service]
    Escrow[Escrow/Split Service]
    Indexer[Indexer Service]
    Notification[Notification Service]
    Analytics[Analytics Service]
    Reputation[Reputation Service]
  end

  subgraph Infra
    NATS[NATS JetStream]
    Postgres[Postgres (per-service DB)]
    OTEL[OTEL Collector]
    Jaeger[Jaeger]
    Prom[Prometheus]
    Grafana[Grafana]
  end

  Envoy -->|gRPC/HTTP| Marketplace
  Envoy -->|gRPC/HTTP| Identity

  Marketplace ---|gRPC| Payments
  Marketplace ---|gRPC| Identity
  Payments ---|gRPC| Identity

  Indexer -->|events| NATS
  Marketplace -->|events| NATS
  Payments -->|events| NATS
  Escrow -->|events| NATS
  Identity -->|events| NATS

  Notification -->|consumes| NATS
  Analytics -->|consumes| NATS
  Reputation -->|consumes| NATS

  Services --> Postgres
  Services --> OTEL
  OTEL --> Jaeger
  Services --> Prom
  Prom --> Grafana

  click NATS "https://nats.io" "NATS JetStream"
  click Jaeger "https://www.jaegertracing.io/" "Jaeger"
  click Prom "https://prometheus.io/" "Prometheus"
