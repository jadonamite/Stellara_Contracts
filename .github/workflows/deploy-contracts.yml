name: Secure Contract Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      network:
        description: 'Target network'
        required: true
        default: 'testnet'
        type: choice
        options: [testnet, mainnet]

jobs:
  validate:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust + wasm target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Stellar CLI
        run: curl --proto '=https' --tlsv1.2 -sSf https://install.stellar.org | sh

      - name: Build contracts
        run: ./build.sh

      - name: Run validation
        run: chmod +x scripts/validate.sh && ./scripts/validate.sh

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-binaries
          path: target/wasm32-unknown-unknown/release/*.wasm
          retention-days: 7

  deploy:
    name: Deploy Contracts
    needs: validate
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.network || 'testnet' }}
    steps:
      - uses: actions/checkout@v4

      - name: Download WASM artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-binaries
          path: target/wasm32-unknown-unknown/release/

      - name: Install Stellar CLI
        run: curl --proto '=https' --tlsv1.2 -sSf https://install.stellar.org | sh

      - name: Make scripts executable
        run: chmod +x scripts/*.sh build.sh

      - name: Deploy contracts
        env:
          STELLAR_SECRET_KEY: ${{ secrets.STELLAR_DEPLOYER_SECRET_KEY }}
          STELLAR_NETWORK: ${{ github.event.inputs.network || 'testnet' }}
          STELLAR_RPC_URL: ${{ secrets.STELLAR_RPC_URL }}
        run: ./scripts/deploy.sh

      - name: Upload deployed contract IDs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: deployed-contracts-${{ github.run_id }}
          path: |
            deployed_contracts.env
            deploy_*.log
          retention-days: 30

      - name: Upload rollback on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-deploy-${{ github.run_id }}
          path: deploy_*.log
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment failed on ${{ github.event.inputs.network || 'testnet' }}"
          echo "::error::Rollback was triggered automatically. Check deploy log artifact."

  monitor:
    name: Post-deployment Health Check
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Stellar CLI
        run: curl --proto '=https' --tlsv1.2 -sSf https://install.stellar.org | sh

      - name: Download deployed contract IDs
        uses: actions/download-artifact@v4
        with:
          name: deployed-contracts-${{ github.run_id }}

      - name: Run health checks
        env:
          STELLAR_NETWORK: ${{ github.event.inputs.network || 'testnet' }}
        run: |
          source deployed_contracts.env
          FAILED=0
          for var in TRADING_ID TOKEN_ID YIELD_FARMING_ID; do
            id="${!var}"
            name="${var/_ID/}"
            if [ -n "$id" ]; then
              echo "Checking $name ($id)..."
              if stellar contract info --id "$id" --network "$STELLAR_NETWORK" >/dev/null 2>&1; then
                echo "::notice::✅ $name is live: $id"
              else
                echo "::error::❌ $name health check failed: $id"
                FAILED=1
              fi
            fi
          done
          exit $FAILED

      - name: Report deployment summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Network:** ${{ github.event.inputs.network || 'testnet' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          if [ -f deployed_contracts.env ]; then
            echo "- **Contracts:**" >> $GITHUB_STEP_SUMMARY
            cat deployed_contracts.env >> $GITHUB_STEP_SUMMARY
          fi